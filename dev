#!/usr/bin/env ruby

# Usage: ./dev [filename]

file = ARGV[0] || "hello.rb"

# Check if the file exists
unless File.exist?(file)
  puts "File not found: #{file}"
  exit 1
end

# Open the file in vscode if exists
if system("command -v code > /dev/null 2>&1")
  system("code #{file}")
end

# Get the initial modification time of the file
last_mtime = File.mtime(file)

puts "Watching #{file} for changes..."
puts "Press Ctrl+C to exit."
puts "Press Enter to execute the file manually."

# Start a thread to listen for Enter key presses
Thread.new do
  loop do
    STDIN.gets

    system("clear")
    system("ruby #{file}")
  end
end

begin
  loop do
    # Sleep for a short period to avoid busy-waiting
    sleep 0.3

    # Get the current modification time of the file
    current_mtime = File.mtime(file)

    # Check if the file has been modified
    if current_mtime != last_mtime
      puts "File changed, executing #{file}..."

      # Update the last modification time
      last_mtime = current_mtime

      # Clean the screen
      system("clear")

      # Execute the file
      system("ruby #{file}")
    end
  end
rescue Interrupt
  puts "\nExiting. Goodbye!"
  exit 0
end
